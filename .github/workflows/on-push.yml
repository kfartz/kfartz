on: push
name: On push
run-name: "Build & Checks â€” ${{ github.ref_name }} by @${{ github.actor }}"

jobs:
  quality_check:
    runs-on: ubuntu-latest
    steps:
      - uses: oven-sh/setup-bun@v1
        with: 
          bun-version: latest

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install deps
        run: bun i --dev

      - name: Linting check
        run: bun lint

      - name: Formatting check
        run: bunx @biomejs/biome format
      
      - name: Fetch origin/master
        run: git fetch origin master

      - name: Commitlint check
        run: bunx @commitlint/cli -V --from origin/master

      - name: Branch name validation
        if: "!startsWith(github.ref_name, 'gh-readonly-queue/') && github.ref_name != 'master'"
        run: git branch --show-current | .github/branch-name-validation.ts

  build_check:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18.1-alpine
        env:
          POSTGRES_PASSWORD: password
        ports: ["5432:5432"]
    steps:
      - uses: oven-sh/setup-bun@v1
        with: 
          bun-version: latest

      - uses: actions/checkout@v5

      - name: Install deps
        run: bun i

      - name: Build
        run: PAYLOAD_SECRET=build DATABASE_URI=postgres://postgres:password@localhost:5432/build bun run build
